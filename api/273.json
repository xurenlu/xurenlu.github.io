{"title":"通过XOOPS模块整合Mu.wordpress的完整方案(一)","zzzContent":"1.先建一个xoops块:\n目录为proxy,以下有\nindex.php,header.php,footer.php,newblog.php,xoops_version.php\n先看xoops_version.php\n<coolcode lang=\"php\">\n<?php\n\n\n\n\n$modversion['name'] = \"博客\";\n$modversion['version'] = 1.00;\n$modversion['description'] = \"与wpmu交互的模块\";\n$modversion['author'] = \"\";\n$modversion['credits'] = \"wpMu proxy\";\n$modversion['help'] = \"system.html\";\n$modversion['license'] = \"GPL see LICENSE\";\n$modversion['official'] = 1;\n$modversion['image'] = \"images/system_slogo.png\";\n$modversion['dirname'] = \"proxy\";\n\n$modversion['hasAdmin'] = 1;\n$modversion['adminindex'] = \"admin.php\";\n$modversion['adminmenu'] = \"menu.php\";\n\n\n// Templates\n\n$modversion['templates'][1]['file'] = 'newblog.html';\n$modversion['templates'][1]['description'] = '';\n\n$modversion['hasMain'] = 1;\n\n?>\n\n</coolcode>\n2.思路:\n用户在点击菜单时，系统会自动判断用户时否已经拥用了WordpressBlog.如果没有，则会显示设定Wordpress的表单。\n文件index.php\n<coolcode lang=\"php\">\n<?php\nrequire_once(\"header.php\");\n$sql=\"select * from wp_users where user_login='\".$xoopsUser->getVar(\"uname\").\"'\";\n$rs=$xoopsDB->query($sql);\n$rows=$xoopsDB->getRowsNum($rs);\nif($rows)\n{\n\trequire_once(\"class/xoops_mu.php\");\n\t$xoops_mu=new xoops_mu();\n\t$xoops_mu->userLogin($xoopsUser->getVar(\"uname\"),md5($xoopsUser->getVar(\"pass\")),time()+365*24*3600,\"/wpmu/\",\".newag.com.cn\");\n\n\theader (\"location:http://\".$xoopsUser->getVar(\"uname\").\".newag.com.cn/wpmu/\");\n}\nelse\n{\n\t$xoopsOption[\"template_main\"]=\"newblog.html\";\n\t$xoopsTpl -> assign(\"email\", $xoopsUser->getVar(\"email\"));\n}\n\n\trequire_once(\"footer.php\");\n\t?>\n</coolcode>\n3.如果用户已经有了blog,那会自动转向到blog中。\n如果没有，是调的一个模板，这个模板询问用户是否要创建一个Wordpress博客。用户选择开通后，会进入newblog.php\nnewblog.php代码:\n<coolcode lang=\"php\">\n<?php\n\trequire_once(\"header.php\");\n\tif(file_exists(\"class/sqlgenerator.php\"))\n\t\trequire_once(\"class/sqlgenerator.php\");\n\trequire_once(\"class/fileoper.php\");\n\n\t$blogtitle=$_POST[\"blogtitle\"];\n\t$blogdomain=$_POST[\"blogdomain\"];\n\t$email=$_POST[\"email\"];\n\n\trequire_once(\"class/xoops_mu.php\");\n\t$xoops_mu=new xoops_mu();\n\tif($xoops_mu->addNewWPUser($xoopsUser->getVar(\"uname\"),$xoopsUser->getVar(\"pass\"),$xoopsUser->getVar(\"email\"),$xoopsUser->getVar(\"uname\").\".newag.com.cn\",\"wpmu\",\"http://\".$xoopsUser->getVar(\"uname\").\".newag.com.cn/wpmu/\",$xoopsUser->getVar(\"uname\")))\n\t{\n\t\t//echo \"创建wp用户成功.<br/>\";\n\t}\n\tif($xoops_mu->CreateBlog($xoopsUser->getVar(\"uname\"),$xoopsUser->getVar(\"uname\").\".newag.com.cn\",$xoopsUser->getVar(\"uname\"),\"/wpmu/\"))\n\t{\n\t\t//echo \"创建Blog成功.<br/>\";\n\t}\n\n\t//$xoopsOption[\"template_main\"]=\"success.html\";\n//\t$xoopsTpl -> assign(\"uname\", $xoopsUser->getVar(\"uname\"));\n\theader(\"location:http://\".$xoopsUser->getVar(\"uname\").\".newag.com.cn/wpmu/\");\n\n\trequire_once(\"footer.php\");\n\t?>\n</coolcode>\n其实主要还是调用了xoops_mu这个类来进行新博客的创建工作。\n经过我的分析，进行了这样一系统工作:\n在wp_site,wp_user,wp_signups三个表中插入了相应的行(感觉有点数据冗余，域名都插入了好几次)，在wp_usermeta中插入了5行数据.然后建了wp_数字_****这样形式的8个表(前一阵看还是7个，记得当时没有wp_*_options这个表，现在又多了一个表).这一系列工作我就没有去细看，直接用phpmyadmin把sql导出了，然后做了相应一些处理后，直接执行了。\n在前面一篇blog的xoops_mu类里。不过注意那个类是没法直接运行的，毕竟只是交流，示例一下WP整合是怎么一个思路。\n有兴趣的话，等我完全搞完后发一个资料内传阅一下。\nPS:个人感觉mu.wordpress.org上的那个版本有点乱，我开始下了一个nightly版本，不过developer太马虎了，居然出来巨搞笑的BUG,用***.com就可以，用***.com.cn，居然图片,js文件的地址就成了com.cn/***了，所以我放弃了，再下的wordpress.mu.1.0Rc4 好像也改动了一些文件。但改了文件版本号应该改一下。","postDate":"2006-10-06 03:52:58","postId":273,"type":"post","status":"publish","imported":true,"file":"273.md"}