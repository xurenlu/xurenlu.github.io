{"title":"WP的多用户版本mu.wordpress与XOOPS的整合...","zzzContent":"这是自己分离出来的代码,没有自己测试,所以很可能无法正常运行。主要是示例wordpress.mu注册和登陆时的一些操作.\n<coolcode lang=\"php\">\n<?php\n\t/**\n\t这个wp_应该跟wp里设的前缀是一样的.\n\t*/\n\n\tdefine(\"WP_DB_PREFIX_FORXOOPS\",\"wp_\");\n\t/**\n\t这是运行WP.mu的主站的域名.\n\t*/\n\tdefine(\"WP_BLOG_HOST_FORXOOPS\",\"www.example.com\");\n\tclass xoops_mu{\n\t\t/**\n\n\t\t在Xoops登陆成功后，请调用一下这个函数，这样在Wordpress中也就能登陆了。\n\t\t注意，这个pass是实际用户输入的pass的两次md5加密。\n\t\t@author renlu xu<helloasp@hotmail.com>\n\t\t*/\n\t\tfunction userLogin($user,$pass,$expire,$path=\"/\",$domain=\"\")\n\t\t{\n\t\t\tif(!($expire>60))\n\t\t\t\t{\n\t\t\t\t\t/**\n\t\t\t\t\t如果没有指定cookie保存时间，默认保存1年。\n\t\t\t\t\t*/\n\t\t\t\t\t$expire=365*24*3600;\n\t\t\t\t}\n\t\t\tif($domain==\"\")\n\t\t\t\t{\n\t\t\t\t\t/**\n\t\t\t\t\t如果没有指定cookie的域名，默认用机器的域名。不过要做多子站的话，要设置一下。比如，设为\".example.com\"。\n\t\t\t\t\t*/\n\t\t\t\t\t$domain=$_SERVER[\"HTTP_HOST\"];\n\t\t\t\t}\n\t\t\tsetcookie(\"wordpressuser\",$user,$expire,$path,$domain);\n\t\t\tsetcookie(\"wordpresspass\",$pass,$expire,$path,$domain);\n\t\t}\n\t\tfunction changepass($uname,$newpass)\n\t\t{\n\t\t\tglobal $xoopsDB;\n\t\t\t$xoopsDB->queryF(\"update \".WP_DB_PREFIX_FORXOOPS.\"users set user_pass='\".md5($newpass).\"' where user_login='\".$uname.\"'\");\n\t\t}\n\n\t\tfunction logout($expire,$path=\"/\",$domain=\"\")\n\t\t{\n\t\t\tif(!($expire>60))\n\t\t\t\t{\n\t\t\t\t\t/**\n\t\t\t\t\t如果没有指定cookie保存时间，默认保存1年。\n\t\t\t\t\t*/\n\t\t\t\t\t$expire=365*24*3600;\n\t\t\t\t}\n\t\t\tif($domain==\"\")\n\t\t\t\t{\n\t\t\t\t\t/**\n\t\t\t\t\t如果没有指定cookie的域名，默认用机器的域名。不过要做多子站的话，要设置一下。比如，设为\".example.com\"。\n\t\t\t\t\t*/\n\t\t\t\t\t$domain=$_SERVER[\"HTTP_HOST\"];\n\t\t\t\t}\n\t\t\tsetcookie(\"wordpressuser\",\"\",$expire,$path,$domain);\n\t\t\tsetcookie(\"wordpresspass\",\"\",$expire,$path,$domain);\n\t\t}\n\t\t/**\n\t\t往Wp中插中新用户的语句.在XOOPS中注册后，应该调用这一个函数。\n\t\t只加用户，不加博客设置。\n\t\t*/\n\t\tfunction addNewWPUser($uname,$upass,$email,$domain=\"\",$path=\"/\",$url=\"\",$nickname=\"\")\n\t\t{\n\t\t\tglobal $xoopsDB;\n\t\t\tif($domain==\"\")\n\t\t\t{\n\t\t\t\t$domain=$uname;\n\t\t\t}\n\t\t\tif($nickname==\"\")\n\t\t\t{\n\t\t\t\t$nickname=$uname;\n\t\t\t}\n\t\t\tif($url==\"\")\n\t\t\t{\n\t\t\t\t$url=\"http://\".$domain.$path;\n\t\t\t}\n\t\t\t$wpInsert[\"user_login\"]=$uname;\n\t\t\t$wpInsert[\"user_pass\"]=$upass;\n\t\t\t$wpInsert[\"user_nicename\"]=$nickname;\n\t\t\t$wpInsert[\"user_email\"]=$email;\n\t\t\t$wpInsert[\"user_url\"]=$url;\n\t\t\t$wpInsert[\"user_registered\"]=date(\"Y-m-d H:i:s\");\n\t\t\t$wpInsert[\"user_status\"]=0;\n\t\t\t$wpInsert[\"display_name\"]=$uname;\n\t\t\t$wpInsert[\"spam\"]=0;\n\t\t\t$wpInsert[\"deleted\"]=0;\n\t\t\t/**\n\t\t\t生成插入数据的sql 语句.\n\t\t\t*/\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"users\",$wpInsert);\n\n\t\t\t$xoopsDB->queryF($sql);\n\n\t\t\t$AffectedRows=$xoopsDB->getAffectedRows();\n\t\t\tif(!$AffectedRows)\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\n\t\t\t$wpInsert=array();\n\t\t\t$wpInsert[\"domain\"]=$domain;\n\t\t\t$wpInsert[\"path\"]=$path;\n\t\t\t$wpInsert[\"title\"]=$_POST[\"title\"];\n\t\t\t$wpInsert[\"user_login\"]=$uname;\n\t\t\t$wpInsert[\"user_email\"]=$email;\n\t\t\t$wpInsert[\"registered\"]=date(\"Y-m-d H:i:s\");\n\t\t\t$wpInsert[\"active\"]=1;\n\t\t\t$wpInsert[\"activation_key\"]=\"000000\";\n\t\t\t$wpInsert[\"meta\"]='a:2:{s:7:\"lang_id\";s:2:\"en\";s:6:\"public\";i:1;}';\n\t\t\t$wpInsert[\"activated\"]=date(\"Y-m-d H:i:s\");\n\t\t    $sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"signups\",$wpInsert);\n\n\t\t\t$xoopsDB->queryF($sql);\n\t\t\t$AffectedRows=0;\n\t\t\t$AffectedRows=$xoopsDB->getAffectedRows();\n\t\t\tif(!$AffectedRows)\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t}\n\t\t/**\n\t\t创建 WP的blog.如果添加WP用户成功，还应调用这一个函数。\n\t\t*/\n\t\tfunction CreateBlog($uname,$udomain,$nickname='',$path=\"/\")\n\t\t{\n\n\t\t\tglobal $xoopsDB;\n\n\t\t\tif($domain==\"\")\n\t\t\t{\n\t\t\t\t$domain=$uname;\n\t\t\t}\n\t\t\t/**\n\t\t\t这一段还不太懂...\n\t\t\t*/\n\t\t\t$wpInsert=array();\n\t\t\t$wpInsert[\"site_id\"]=1;\n\t\t\t$wpInsert[\"domain\"]=$udomain;\n\t\t\t$wpInsert[\"path\"]=$path;\n\t\t\t$wpInsert[\"registered\"]=date(\"Y-m-d H:i:s\");\n\t\t\t$wpInsert[\"public\"]=1;\n\t\t\t$wpInsert[\"archived\"]=0;\n\t\t\t$wpInsert[\"mature\"]=0;\n\t\t\t$wpInsert[\"spam\"]=0;\n\t\t\t$wpInsert[\"deleted\"]=0;\n\t\t\t$wpInsert[\"lang_id\"]=0;\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"blogs\",$wpInsert);\n\t\t\t$xoopsDB->queryF($sql);\n\n\n\n\n\t\t\t/**\n\t\t\t得到wp中的uid\n\t\t\t*/\n\t\t\t$sql=(\"select * from \".WP_DB_PREFIX_FORXOOPS.\"users where user_login='\".$uname.\"'\");\n\t\t\t$rs=$xoopsDB->query($sql);\n\t\t\t$row=$xoopsDB->FetchArray($rs);\n\n\t\t\t$id=$row[\"ID\"];\n\t\t\t$url=$row[\"user_url\"];\n\t\t\t$email=$row[\"user_email\"];\n\n\n\t\t\t$sql=fileoper::readover(\"wp_newblog.sql\");\n\n\t\t\t/**\n\t\t\t得到了一系统插入乱七八糟的数据的SQL，我还没有去分析这些都是做什么的。\n\t\t\t不过我试着删除了几条记录，再创建的用户就无法登陆了，看来不要随便改。\n\t\t\t为了提示数据库性能，可以试探着删一些东西去，毕竟WP不知道都插入了一些什么东东。\n\t\t\t*/\n\n\t\t\t$sql=str_replace(\"{WP}\",WP_DB_PREFIX_FORXOOPS.\"$id\",$sql);\n\t\t\t$sql=str_replace(\"{WP_SITE_URL}\",\"http://\".WP_BLOG_HOST_FORXOOPS.$path,$sql);\n\t\t\t$sql=str_replace(\"{WP_HISSITE_URL}\",$url,$sql);\n\t\t\t$sql=str_replace(\"{WP_HISEMAIL}\",$email,$sql);\n\t\t\t$sql=str_replace(\"{WP_AUTHOR}\",$id,$sql);\n\t\t\t$sql=str_replace(\"r\",\"\",$sql);\n\t\t\t$a=explode(\";n\",$sql);\n\t\t\twhile(list($k,$v)=each($a)){\n\t\t\t\t$xoopsDB->queryF($v);\n\t\t\t}\n\n\t\t\t/**\n\t\t\t现在插入的这几个是比较重要的，好像缺少了就无法运行。\n\t\t\t*/\n\t\t\t$wpInsert[\"user_id\"]=$id;\n\t\t\t$wpInsert[\"meta_key\"]=\"nickname\";\n\t\t\t$wpInsert[\"meta_value\"]=$nickname;\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"usermeta\",$wpInsert);\n\n\n\t\t\t$wpInsert[\"user_id\"]=$id;\n\t\t\t$wpInsert[\"meta_key\"]=\"primary_blog\";\n\t\t\t$wpInsert[\"meta_value\"]=$id;\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"usermeta\",$wpInsert);\n\n\n\t\t\t$wpInsert[\"user_id\"]=$id;\n\t\t\t$wpInsert[\"meta_key\"]=\"source_domain\";\n\t\t\t$wpInsert[\"meta_value\"]=\"$udomain\";\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"usermeta\",$wpInsert);\n\n\n\t\t\t$wpInsert[\"user_id\"]=$id;\n\t\t\t$wpInsert[\"meta_key\"]=\"wp_\".$id.\"_capabilities\";\n\t\t\t$wpInsert[\"meta_value\"]='a:1:{s:13:\"administrator\";b:1;}';\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"usermeta\",$wpInsert);\n\n\n\t\t\t$wpInsert[\"user_id\"]=$id;\n\t\t\t$wpInsert[\"meta_key\"]=\"wp_\".$id.\"_user_level\";\n\t\t\t$wpInsert[\"meta_value\"]=\"10\";\n\t\t\t$sql=sqlgenerator::insert(WP_DB_PREFIX_FORXOOPS.\"usermeta\",$wpInsert);\n\n\t\t}\n\n\t}\n\t?>\n</coolcode>","postDate":"2006-10-05 19:42:58","postId":272,"type":"post","status":"publish","imported":true,"file":"272.md"}