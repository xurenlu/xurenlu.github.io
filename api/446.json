{"title":"phpfox全攻略","zzzContent":"phpfox是国外的一款社区软件，具有论坛，博客，相册，音乐，投票，问答，视频等功能，基于php,mysql.安装需要gd库的支持。\n\n我拿到程序后修改的第一步:\n\n1.修改用户接口部分。 phpfox是典型的单入口型程序和类MVC架构。具体怎么改我不加描述了，只提一下，因为phpfox把对几乎所有路径的访问全部rewrite到了index.php，所以要在.htaccess文件中加上这样的两行:\n<coolcode>\nRewritecond %{REQUEST_FILENAME} !-f\nRewritecond %{REQUEST_FILENAME} !-d\n</coolcode>\n一共要加两次（针对1.5,1.6这两个版本)。如果没有启用rewrite,就没有这会事。用户分别是{PREFIX}_user表，如果自行进行数据整合，操作这个表就可以了。\n2.汉字在显示时有问题，需要看以下这些模板：\n<blockquote>    design/./templates/default/_modules/Menu/TabbedMenu.html\ndesign/./templates/default/_modules/Listing/ListingCreate.html\ndesign/./templates/default/_modules/Listing/ListingCreate.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Account/ProfileSettings.html\ndesign/./templates/default/_modules/Ads/AdsList.html\ndesign/./templates/default/_modules/Event/Calendar.html\ndesign/./templates/default/_modules/Event/AddForm.html\ndesign/./templates/default/_modules/Event/AddForm.html\ndesign/./templates/default/_modules/Event/AddForm.html\ndesign/./templates/default/_modules/Event/AddForm.html\ndesign/./templates/default/_modules/Event/AddForm.html\ndesign/./templates/default/_modules/Event/FeaturedEvents.html\ndesign/./templates/default/_modules/Event/FeaturedEvents.html\ndesign/./templates/default/_modules/Event/EventView.html\ndesign/./templates/default/_modules/Event/EditForm.html\ndesign/./templates/default/_modules/Event/EditForm.html\ndesign/./templates/default/_modules/Event/EditForm.html\ndesign/./templates/default/_modules/Event/EditForm.html\ndesign/./templates/default/_modules/Event/EditForm.html\ndesign/./templates/default/_modules/Video/Main.html\ndesign/./templates/default/_modules/Video/AjaxBox.html\ndesign/./templates/default/_modules/Video/ModifyCategories.html\ndesign/./templates/default/_modules/Video/ApproveVideos.html\ndesign/./templates/default/_modules/Video/AjaxLatest.html\ndesign/./templates/default/_modules/Video/Categories.html\ndesign/./templates/default/_modules/Video/Browse.html\ndesign/./templates/default/_modules/Video/View.html\ndesign/./templates/default/_modules/Blog/NewBlogs.html\ndesign/./templates/default/_modules/Blog/MemberBlogs.html\ndesign/./templates/default/_modules/Blog/AddBlog.html\ndesign/./templates/default/_modules/Blog/MyPageBlogs.html\ndesign/./templates/default/_modules/Blog/MyPageBlogView.html\ndesign/./templates/default/_modules/Blog/BlogList.html\ndesign/./templates/default/_modules/Blog/BlogList.html\ndesign/./templates/default/_modules/Blog/BlogList.html\ndesign/./templates/default/_modules/Blog/BlogList.html\ndesign/./templates/default/_modules/Blog/EditBlog.html\ndesign/./templates/default/_modules/Blog/EditBlog.html\ndesign/./templates/default/_modules/Blog/View.html\ndesign/./templates/default/_modules/Blog/View.html\ndesign/./templates/default/_modules/Groups/GroupForumPosts.html\ndesign/./templates/default/_modules/Groups/NewGroups.html\ndesign/./templates/default/_modules/Groups/GroupDetails.html\ndesign/./templates/default/_modules/Shoutbox/Box.html\ndesign/./templates/default/admin/language/options.html\ndesign/./templates/default/admin/language/options.html\ndesign/./templates/default/admin/language/options.html\ndesign/./templates/default/admin/language/missing-options.html\ndesign/./templates/default/admin/language/add-phrase.html\ndesign/./templates/default/admin/language/add-phrase.html\ndesign/./templates/default/admin/language/phrases.html\ndesign/./templates/default/admin/language/phrases.html\ndesign/./templates/default/admin/language/phrases.html\ndesign/./templates/default/admin/language/add-option.html\ndesign/./templates/default/admin/language/missing.html</blockquote>\n里面会有&lt;{$title|escape}&gt;这样的句子。将\"|escape\"删掉即可修正汉字bug.\n3.敏感词过滤：phpfox为了扩展性，是在显示时过滤的，没有这个必要。我们把显示层的过小滤去掉，然后在index.php的第一行就加上过滤（如果有post数据，将之过滤）。这样将过滤机制更改之后，CPU又节省不少。\n4.未登陆用户cache层。对于未登陆用户，没必要时时都是显示最新的。又是在index.php的第一行加上过滤：如果用户未登陆且无post数据，则显示cache层的静态文件。有1%的机率更新cache.\n\n优化之前:\n<blockquote> Document\nPath:          /\nDocument Length:        23960 bytes\nConcurrency Level:      1\nTime taken for tests:   2.740130 seconds\nComplete requests:      30\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      733950 bytes\nHTML transferred:       718800 bytes\nRequests per second:    10.95 [#/sec] (mean)\nTime per request:       91.338 [ms] (mean)\nTime per request:       91.338 [ms] (mean, ac</blockquote>\n优化之后:\n<blockquote> Server Software:        Apache/2.2.4\nServer Hostname:        ***.com\nServer Port:\n80\nDocument Path:          /\nDocument Length:        23960 bytes\nConcurrency Level:      1\nTime taken for tests:   0.32685 seconds\nComplete requests:      30\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      730560 bytes\nHTML transferred:       718800 bytes\nRequests per second:    917.85 [#/sec] (mean)\nTime per request:       1.090 [ms] (mean)\nTime per request:       1.090 [ms] (mean, across\nall concurrent requests)\nTransfer rate:          21814.29\n[Kbytes/sec] received\nConnection Times (ms)\nmin  mean[+/-sd] median   max\nConnect:        0\n0   0.0\n0       0\nProcessing:     0    0\n1.0      1       1\nWaiting:        0\n0   0.3\n0       1\nTotal:          0\n0   1.0\n1       1</blockquote>\n又节约了不少资源。\n\n4。数据库结构修改：\n\na.<a href=\"http://10.200.4.242/pa/tbl_properties_structure.php?db=phpfox&amp;table=phpfox_online_session&amp;token=f72eb4f06c035089953cb1076174c571\" class=\"item\">phpfox_online_session</a>,phpfox_online,<a href=\"http://10.200.4.242/pa/tbl_properties_structure.php?db=phpfox&amp;table=phpfox_site_session&amp;token=f72eb4f06c035089953cb1076174c571\" class=\"item\">phpfox_site_session</a>的数据都不需要永久保存。直接改成内存表。\n\n由于内存表不支持txt类型，因此将tinytxt,text类型的字段均改为varchar字段。\n\n现在做的改动有:\n\nphpfox_online:\n\nuser(   tinytext)  改为:user(varchar(32)\n\npage (tinytext )改为page(varchar(100)\n\nip(tinytext)改为(varchar(16) )\n\nphpfox_site_session:\n\nbrowser:改为varcahr(64)\n\nhost:改为varchar(32)\n\npage:改为varchar(64)\n\nreferer:改为varchar(64).\n\n这个改过之后我试了一下，有些字段长度还可以进一步改小，这样才能将session数据都做成内存表，速度又可以大上一层楼。\nb.<a href=\"http://10.200.4.242/pa/tbl_properties_structure.php?db=phpfox&amp;table=flashchat_templates&amp;token=f72eb4f06c035089953cb1076174c571\" class=\"item\">flashchat_templates</a>\n这个表非常搞笑，有2万条记录，好像是在\"CAN I FUCK YOU\"和\"&lt;srai&gt;DO YOU WANT TO HAVE\nSEX&lt;/srai&gt;\"类似的句子之间做替换。基本没用（尤其是对中文).依我的看法如果这个表能导致瓶颈，就清空掉好了。\n\nc.<a href=\"http://10.200.4.242/pa/tbl_properties_structure.php?db=phpfox&amp;table=flashchat_patterns&amp;token=f72eb4f06c035089953cb1076174c571\" class=\"item\">flashchat_patterns</a>\n这个表巨大无比，有15万条记录。主要是英文。如果可以的话，可以给他瘦身一下。\n\nd.mysql的连接方式为mysql_connect,这个可以修改为mysql_pconnect。视具体情况。\ne.许多表没有加索引，最搞的是论坛的topic表没有给group_id这个字段加索引。真是让人郁闷。注意把数据库结构整个看一遍，挨个把屁股擦干净。\n\n5.去掉title中的标识:\n<blockquote> 修改include/modules/Site/classes/PhpFox_ComponentSiteTitle.class.php\n中，将第200行的:\n\n198      if (App::removeBrand())\n\n199         {\n\n200            // $sTitle\n.= ' (Powered by phpFoX)';\n\n201         }\n\n改掉就行了。（提醒大家，phpfox不允许未付费用户去这个标识。去这个标识需要另付费75$.</blockquote>\n好啦，现在他可以支撑1000人在线了(其实我还加装了php-apc,这个东东把php编译结果缓存起来,另外把图片等静态文件进行了分流)。","postDate":"2007-08-13 23:47:53","postId":446,"type":"post","status":"publish","imported":true,"file":"446.md"}