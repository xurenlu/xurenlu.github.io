{"title":"用PHP5.2+APC实现超酷的PHP进度条","zzzContent":"英文原文（并非按词一个个译过来的)\nhttp://martinjansen.com/2007/04/upload-progress/\n<a href=\"http://progphp.com/progress.php\">这里</a>是Rasmus Lerdorf实现的一个利用php5.2的新特性来进行上传进度条的例子。\n为了让php存储并显示文件上传进度，他利用了APC来实现内存级缓存。APC最新的版本有一个特性（虽然没有文档化），一旦开启，将会监听包含 APC_UPLOAD_PROGRESS的表单的文件上传进度。一旦发现这个POST变量，APC将会创建一个缓存入口，并把文件上传进度放到这个缓存里。这个入口的值取决于POST变量APC_UPLOAD_PROGRESS的值 。\n\n如果你仔细看他的例子代码，你发现他用了apc_fetch来读内存值。同时在共享内存里，包含了APC_UPLOAD_PROGRESS这个魔术数字。\n\n但是怎么让APC像这样工作呢？<a href=\"http://cn.php.net/manual/zh/ref.apc.php\">文档</a>中并没有告诉我们。其实在CVS里的安装说明上写了：\n在php.ini文件设置apc.rfc1867=1就行了。\n\n我把例子代码弄过来了:\n<coolcode lang=\"php\">\nif($_SERVER['REQUEST_METHOD']=='POST') {\n    $status = apc_fetch('upload_'.$_POST['APC_UPLOAD_PROGRESS']);\n    $status['done']=1;\n    echo json_encode($status);\n    exit;\n} else if(isset($_GET['progress_key'])) {\n    $status = apc_fetch('upload_'.$_GET['progress_key']);\n    echo json_encode($status);\n    exit;\n}\n?>\n\n\n<script type=\"text/javascript\" src=\"/yui/yahoo.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/event.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/dom.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/animation.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/dragdrop.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/connection.js\"></script>\n<script type=\"text/javascript\" src=\"/yui/container.js\"></script>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"/yui/build/container/assets/container.css\" /><script type=\"text/javascript\">\nvar fN = function callBack(o) {\nvar resp = eval('(' + o.responseText + ')');\n    var rate = parseInt(resp['rate']/1024);\n        if(resp['cancel_upload']) {\n              txt=\"Cancelled after \"+resp['current']+\" bytes!\";\n         } else {\n                    txt=resp['total']+\" bytes uploaded!\";\n         }    txt += \"    Upload rate was \"+rate+\" kbps.\";\n             document.getElementById('pbar').style.width = '100%';\n                 document.getElementById('ppct').innerHTML = \"100%\";    document.getElementById('ptxt').innerHTML = txt;\n                     setTimeout(\"progress_win.hide(); window.location.reload(true);\",2000);\n        }\n        var callback = { upload:fN }\n\n    var fP = function callBack(o) {    var resp = eval('(' + o.responseText + ')');    if(!resp['done']) {       if(resp['total']) {        var pct = parseInt(100*(resp['current']/resp['total']));        document.getElementById('pbar').style.width = ''+pct+'%';        document.getElementById('ppct').innerHTML = \" \"+pct+\"%\";        document.getElementById('ptxt').innerHTML = resp['current']+\" of \"+resp['total']+\" bytes\";      }      setTimeout(\"update_progress()\",500);    } else if(resp['cancel_upload']) {      txt=\"Cancelled after \"+resp['current']+\" bytes!\";       document.getElementById('ptxt').innerHTML = txt;      setTimeout(\"progress_win.hide(); window.location.reload(true);\",2000);    }  }  var progress_callback = { success:fP }\n\n    function update_progress() {    progress_key = document.getElementById('progress_key').value;    YAHOO.util.Connect.asyncRequest('GET','progress.php?progress_key='+progress_key, progress_callback);  }\n\n    var progress_win;\n\n    function postForm(target,formName) {\n    YAHOO.util.Connect.setForm(formName,true);\n    YAHOO.util.Connect.asyncRequest('POST',target,callback);  /* Is there some event that triggers on an aborted file upload? */  /*   YAHOO.util.Event.addListener(window, \"abort\", function () { alert('abort') } ); */    progress_win = new YAHOO.widget.Panel(\"progress_win\", { width:\"421px\", fixedcenter:false, underlay:\"shadow\", close:false, draggable:true, modal:true, effect:{effect:YAHOO.widget.ContainerEffect.FADE, duration:0.3} } );    progress_win.setHeader(\"Uploading \"+document.getElementById('test_file').value+\" ...\");    progress_win.setBody('\n            <div style=\"height: 1em; width: 400px; border:1px solid #000;\">\n            <div id=\"pbar\" style=\"background: #99e; height: 98%; width:0%; float:left;\"> </div>\n            <div id=\"ppct\" style=\"height: 90%; position: absolute; margin: 1 0 0 185;\">0%</div>\n            </div>\n            <div id=\"ptxt\" style=\"margin: 3 0 0 5\">0 of 0 bytes</div>\n            ');    progress_win.render(document.body);    update_progress();  }</script>\n\n    <form method=\"post\" onsubmit=\"postForm('progress.php','upload_form'); return false;\" id=\"upload_form\"><input name=\"APC_UPLOAD_PROGRESS\" type=\"hidden\" id=\"progress_key\" /><input name=\"test_file\" type=\"file\" id=\"test_file\" />\n    <input type=\"submit\" /> </form>\n    <p id=\"progress_win\">&nbsp;</p>\n</coolcode>\n\n附本人意见：\nphp5.2之前解决大文件上传进度条显示一种是猜临时文件名另一种是用php创建webserver,需要iptables打开一些80之外的端口，还有一些是自己编译apache或php模块，基本没太大用途。有时间我详细说一下这几种情况。\n目前这个看起来似乎是一个比较漂亮的解决办法。但是仍需要系统管理员(root)权限来装APC和改php.ini文件。\n希望在更新版本中php能给出一个比较好的解决文件上传的办法。","postDate":"2007-04-30 09:39:03","postId":406,"type":"post","status":"publish","imported":true,"file":"406.md"}